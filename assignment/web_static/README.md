# 实时场景（web_static）

该目录提供新版“实时场景”前端实现：左列由 Three.js 渲染可交互的 3D 大楼，楼层、候梯队列、电梯轿厢与乘客动效统一在一张 WebGL 场景中；右列展示调度指标、电梯状态和楼层排队信息。新版完全舍弃了原来的 2D DOM 拼贴与 PixiJS，转为程序化生成的立体楼宇与光照效果。

## 设计亮点

- **Three.js 3D 舞台**：使用 `THREE.WebGLRenderer`、实体光源与点光营造现代大楼氛围，楼层与电梯在同一 3D 坐标系内运动。
- **程序化楼宇**：根据楼层/电梯数量动态生成大楼尺寸、窗格矩阵、地面与外立面，无需固定贴图即可适配 10～60 层，并追加基座/屋顶/灯光节点强化空间感。
- **候梯光带 + 乘客贴图**：上下行队列以半透明光带呈现，同时使用乘客贴图（Noto Emoji）排布 3D 精灵展示人数，排队越多光亮越强。
- **乘客动画与楼层鸟瞰**：队列/轿厢人数变动触发轻量动画，并新增楼层 mini-map 可一键定位 20 层以上的大型场景。
- **光影与场景环境**：新增基座、广场、灯柱、绿化与天空穹顶，配合多光源与雾效强化夜景氛围。
- **统一几何基准**：候梯面板、楼层标签、电梯运行都基于同一 `floorRatio` 计算，彻底消除左右列错位。
- **自适应布局**：实时场景根据右侧信息列高度拉伸，测试中 canvas 高度与布局参数一一对应，自动化检查更稳定。
- **极端场景优化**：楼层 > 40 或电梯 > 5 时自动收缩楼层高度、调整井道间距，仍保持可读性。
- **动效与交互**：速度开关、调度状态与三维动画联动；若开启“减少动态效果”，会弱化光带闪烁。同时支持鼠标拖拽/滚轮微调视角与缩放。

## 关键文件

- `index.html`：页面骨架、控制面板和双列布局。
- `style.css`：整体视觉皮肤以及场景容器的版式设置。
- `main.js`：基于 Three.js 的 `StageRenderer`、状态轮询与交互逻辑。
- `assets/`：保留历史素材说明（Kenney City Kit、Noto Emoji）；现版楼宇为程序化渲染，不再直接依赖贴图。

## 与后端配合

- 依赖 `assignment/web_dashboard.py` 曝露的 `/dashboard/state` 与 `/dashboard/traffic/list` 接口获取调度状态。
- 切换测试用例或启停调度时，前端会重建 Pixi 舞台并重新计算布局参数。

## 自动化验证

`tests/ui/test_realtime_scene.py` 使用 Playwright 启动本地静态服务器，主要校验：

1. 实时场景列与右侧信息列高度基本相等；
2. 在不同楼层/电梯规模下，行高、候梯宽度、电梯井宽等几何指标满足预期范围；
3. 候梯高亮与乘客贴图正确呈现。

## 本地启动

```bash
python -m assignment.web_dashboard
# 浏览器访问 http://127.0.0.1:8050
```

选择“测试用例”后页面会自动载入，随后点击“启动调度”即可查看实时场景效果。可通过顶部楼层鸟瞰快速跳转关注的楼层。

## 已知事项

- 推荐在 ≥1360px 宽度的屏幕下浏览；窄屏会退化为单列布局，舞台缩放范围有限。
- 超过 80 层或 6 台电梯以上时，会自动压缩行高并减少队列列数，属预期行为。
- 若浏览器开启“减少动态效果”，候梯光带与轿厢流光会被弱化。
